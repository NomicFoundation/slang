use crate::lexer::lexemes;
use slang_solidity_v2_cst::structured_cst::nodes::*;
use crate::parser::nodes::*;
use bumpalo::Bump;
use bumpalo::collections::Vec;

grammar<'arena, 'source>(arena: &'arena Bump, source: &'source str);

Sep<S, T>: Vec<'arena, T> = {
    => Vec::new_in(arena),
    SepOne<S, T> => <>,
};

SepOne<S, T>: Vec<'arena, T> = {
    <e:T> => {
        bumpalo::vec![in arena; e]
    },
    <mut v: SepOne<S, T>> S <e: T> => {
        v.push(e);
        v
    },
};

#[inline]
Rep<T>: Vec<'arena, T> = {
    => Vec::new_in(arena),
    RepOne<T> => <>,
};

RepOne<T>: Vec<'arena, T> = {
    <T> => {
        bumpalo::vec![in arena; <>]
    },
    <mut v: RepOne<T>> <e: T> => {
        v.push(e);
        v
    },
};

{% for section in model.parser.sections -%}

// Rules for section {{ section.title }}

{% for topic in section.topics -%}
    // Rules for topic {{ topic.title }}
    {% for item in topic.items -%}

    {%- if item.type == "Verbatim" %}
    {{ item.content }}
    {% else -%}

    {%- for item in item.content -%}
    {% if item.inline %}#[inline]
    {% endif %}{% if item.pubb -%} pub {% endif -%} {{ item.name }}: {{ item.producing_type }}<'arena> = {
        {% for option in item.options -%}
            {% for field in option.fields -%}   
                <{{ field.capturing_name }}: {{ field.rule }}> {{ " " }}
            {%- endfor %}=> {% if option.constructor -%}
            {{ option.constructor | snake_case }}(arena, <>)
            {%- else -%}
            <>
            {%- endif %},
        {% endfor %}
    };
    {% endfor %}
    {%- endif -%}

    {%- endfor %}

{% endfor %}


{% endfor %}

// Lexemes formatting
{% for id, lexemes in model.parser.terminals -%}
{% if id != "Identifier" -%}
#[inline]
{{ id }}: {{ id }}<'arena> = {
{% for lexeme in lexemes %}
        <l:@L> L_{{ lexeme }} <r:@L> => new_{{id | snake_case}}(arena, <>, source),
{% endfor %}
};
{%- else -%}
#[inline]
Identifier: Identifier<'arena> = {
    SomeIdentifier<""> => <>,
};

// Making an Identifier inline generates an explosion of states, so DON't
SomeIdentifier<Except>: {{ id }}<'arena> = {
{% for lexeme in lexemes %}
        <l:@L> L_{{ lexeme }} <r:@L> if Except !~ "{{ lexeme }}" => new_{{id | snake_case}}(arena, <>, source),
{% endfor %}
};

{%- endif %}
{% endfor %}


extern {
    type Location = usize;
    // TODO(v2): error recovery
    type Error = ();

    enum lexemes::LexemeKind {
        {% for kind in model.parser.lexer.lexeme_kinds -%}
            L_{{ kind }} => lexemes::LexemeKind::{{ kind }},
        {% endfor %}
    }
}
