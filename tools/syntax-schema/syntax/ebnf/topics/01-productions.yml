# yaml-language-server: $schema=../../schema/topic.schema.json

- name: grammar
  config:
    nomap: true
    prelude: |
      use crate::schema::Production;
      pub type GrammarParserResultType = Vec<Production>;
  sequence:
    - reference: IGNORE
    - zeroOrMore:
        reference: production
    - end: ~

- name: production
  sequence:
    - reference: Identifier
    - terminal: "="
    - reference: expression
    - terminal: ;

- name: expression
  oneOrMore:
    reference: sequence
    separator:
      terminal: "|"

- name: sequence
  oneOrMore:
    reference: difference

- name: difference
  sequence:
    - reference: negation
    - optional:
        sequence:
          - terminal: "-"
          - reference: negation

- name: negation
  sequence:
    - optional:
        terminal: ¬
    - reference: primary

- name: primary
  config: { nomap: true }
  choice:
    - reference: productionReference
    - reference: grouped
    - reference: optional
    - reference: repeated
    - reference: charRange
    - reference: EOF
    - reference: String

- name: productionReference
  reference: Identifier

- name: grouped
  config: { nomap: true }
  sequence:
    - terminal: (
    - reference: expression
    - terminal: )

- name: repetitionPrefix
  config: { nomap: true }
  sequence:
    - choice:
        - sequence:
            - reference: Number
            - optional:
                sequence:
                  - terminal: "…"
                  - optional:
                      reference: Number
          config: { map: repetition_prefix_1 }
        - sequence:
            - terminal: "…"
            - reference: Number
          config: { map: repetition_prefix_2 }
    - terminal: "*"

- name: repetitionSeparator
  config: { nomap: true }
  sequence:
    - terminal: "/"
    - reference: expression

- name: repeated
  sequence:
    - optional:
        reference: repetitionPrefix
    - terminal: "{"
    - reference: expression
    - optional:
        reference: repetitionSeparator
    - terminal: "}"

- name: optional
  sequence:
    - terminal: "["
    - reference: expression
    - terminal: "]"

- name: charRange
  sequence:
    - reference: SingleCharString
    - terminal: …
    - reference: SingleCharString

# Tokens

- name: EOF
  is_token: true
  terminal: $

- name: Number
  is_token: true
  oneOrMore:
    range: { from: "0", to: "9" }

- name: String
  is_token: true
  sequence:
    - terminal: "'"
    - zeroOrMore:
        reference: StringChar
    - terminal: "'"

- name: StringChar
  is_token: true
  config: { nomap: true }
  choice:
    - not:
        choice:
          - terminal: "'"
          - terminal: "\\"
    - sequence:
        - terminal: "\\"
        - choice:
            - terminal: "'"
            - terminal: "\\"
            - sequence:
                - terminal: "u{"
                - repeat:
                    min: 1
                    max: 6
                    reference: HexDigit
                  config: { map: hex_digits_to_char, unwrap: true }
                - terminal: "}"

- name: SingleCharString
  is_token: true
  config: { nomap: true }
  sequence:
    - terminal: "'"
    - reference: StringChar
    - terminal: "'"

- name: HexDigit
  is_token: true
  config: { nomap: true }
  choice:
    - range:
        from: "0"
        to: "9"
    - range:
        from: a
        to: f
    - range:
        from: A
        to: F

- name: Identifier
  is_token: true
  config: { nomap: true }
  choice:
    - sequence:
        - terminal: «
        - reference: RawIdentifier
        - terminal: »
      config: { map: identifier_1 }
    - reference: RawIdentifier
      config: { map: identifier_2 }

- name: RawIdentifier
  config: { chain: true }
  is_token: true
  sequence:
    - reference: IdentifierStart
    - zeroOrMore:
        reference: IdentifierFollow

- name: IdentifierStart
  is_token: true
  config: { nomap: true }
  choice:
    - terminal: _
    - range:
        from: a
        to: z
    - range:
        from: A
        to: Z

- name: IdentifierFollow
  is_token: true
  config: { nomap: true }
  choice:
    - reference: IdentifierStart
    - range:
        from: "0"
        to: "9"

- name: IGNORE
  is_token: true
  config: { ignore: true }
  zeroOrMore:
    choice:
      - reference: Whitespace
      - reference: Comment

- name: Comment
  is_token: true
  config: { ignore: true }
  sequence:
    - terminal: /*
    - zeroOrMore:
        choice:
          - not:
              terminal: "*"
            config: { ignore: true }
          - sequence:
              - oneOrMore:
                  terminal: "*"
              - not:
                  choice:
                    - terminal: "*"
                    - terminal: /
            config: { ignore: true }
    - oneOrMore:
        terminal: "*"
    - terminal: /

- name: Whitespace
  is_token: true
  config: { ignore: true }
  choice:
    - terminal: "\t"
    - terminal: "\n"
    - terminal: "\r"
    - terminal: " "
