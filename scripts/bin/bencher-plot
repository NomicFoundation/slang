#!/bin/bash

# usage: bencher-plot project branch testbed benchmarks measure title

set -e
shopt -s inherit_errexit

project=$1
branch=$2
testbed=$3
benchmarks=$4
title=$5

function get_branch() {
  details=$(bencher branch list "${project}" --name "${branch}")
  echo "${details}" | jq -r ".[].uuid"
}

function get_testbed() {
  details=$(bencher testbed list "${project}" --name "${testbed}")
  echo "${details}" | jq -r ".[].uuid"
}

function get_benchmarks() {
  details=$(bencher benchmark list --search "${benchmarks}" "${project}")
  echo "${details}" | jq -r '. - map(select(.name | contains("resolve_all_bindings"))) - map(select(.name | contains("init_bindings"))) | map("--benchmarks " + .uuid) | join(" ")'
}

function get_measure() {
  details=$(bencher measure list "${project}" --name "Duration")
  echo "${details}" | jq -r ".[].uuid"
}

branch_uuid=$(get_branch)
testbed_uuid=$(get_testbed)
benchmarks_uuid=$(get_benchmarks)
measure_uuid=$(get_measure)

set -xe

# benchmarks_uuid is a list of options, so it shouldn't be quoted.
# shellcheck disable=SC2086,SC2250
bencher plot create --branches "${branch_uuid}" --measures "${measure_uuid}" --testbeds "${testbed_uuid}" --x-axis date_time --window 2419200 $benchmarks_uuid --title "${title}" "${project}"
