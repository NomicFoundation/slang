name: check
on: [push]

jobs:
  check:
    runs-on: ubuntu-22.04
    steps:
      - name: Clone repository
        uses: actions/checkout@v3.1.0
      - name: Restore hermit cache
        uses: actions/cache@v3.0.9
        with:
          path: .hermit/
          key: hermit-cache-${{ hashFiles('Cargo.lock', 'package-lock.json', 'Pipfile.lock') }}
          restore-keys: hermit-cache-
      - name: Restore build cache
        uses: actions/cache@v3.0.9
        with:
          path: target/
          key: build-cache-${{ hashFiles('Cargo.lock', 'package-lock.json', 'Pipfile.lock') }}
          restore-keys: build-cache-
      - name: Build devcontainer
        uses: ./.devcontainer
        with: { entrypoint: echo } # empty entrypoint for timing
      - name: Cargo check
        uses: ./.devcontainer
        with: { entrypoint: scripts/cargo/check.sh }
      - name: Cargo test
        uses: ./.devcontainer
        with: { entrypoint: scripts/cargo/test.sh }
      - name: Run linters
        uses: ./.devcontainer
        with: { entrypoint: scripts/linting/lint.sh }
      - name: Build documentation
        uses: ./.devcontainer
        with: { entrypoint: scripts/documentation/build.sh }
      - name: Repossess cached files # as they are modified by devcontainer (root) user
        run: sudo chown -R $USER:$USER "$GITHUB_WORKSPACE"
